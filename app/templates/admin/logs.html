{% extends "admin/base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">ðŸ“‹ System Logs</h1>

    <!-- Filter and Search -->
    <div class="bg-white shadow-md rounded-lg p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">Filter Logs</h2>
        <form method="GET" class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <label for="level" class="block text-sm font-medium text-gray-700">Log Level</label>
                <select id="level" name="level" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="" {% if not level_filter %}selected{% endif %}>All Levels</option>
                    <option value="INFO" {% if level_filter == 'INFO' %}selected{% endif %}>INFO</option>
                    <option value="DEBUG" {% if level_filter == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                    <option value="WARN" {% if level_filter == 'WARN' %}selected{% endif %}>WARN</option>
                    <option value="ERROR" {% if level_filter == 'ERROR' %}selected{% endif %}>ERROR</option>
                </select>
            </div>
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700">Search Message</label>
                <input type="text" id="search" name="search" value="{{ search }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Search logs...">
            </div>
            <div class="flex items-end gap-2">
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                    Filter
                </button>
                <a href="{{ url_for('admin.export_logs') }}" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                    Export as CSV
                </a>
            </div>
        </form>
    </div>

    <!-- Logs Table -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Recent System Activity</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="logs-table-body">
                    {% for log in logs.items %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if log.level == 'INFO' %}bg-green-100 text-green-800{% endif %}
                                {% if log.level == 'DEBUG' %}bg-blue-100 text-blue-800{% endif %}
                                {% if log.level == 'WARN' %}bg-yellow-100 text-yellow-800{% endif %}
                                {% if log.level == 'ERROR' %}bg-red-100 text-red-800{% endif %}">
                                {{ log.level }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ log.message }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">
                            No logs available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        {% if logs.has_prev or logs.has_next %}
        <div class="p-4 border-t">
            <nav class="flex items-center justify-between">
                <div>
                    {% if logs.has_prev %}
                    <a href="{{ url_for('admin.system_logs', page=logs.prev_num, level=level_filter, search=search) }}" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        Previous
                    </a>
                    {% endif %}
                </div>
                <div class="text-sm text-gray-700">
                    Page {{ logs.page }} of {{ logs.pages }}
                </div>
                <div>
                    {% if logs.has_next %}
                    <a href="{{ url_for('admin.system_logs', page=logs.next_num, level=level_filter, search=search) }}" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        Next
                    </a>
                    {% endif %}
                </div>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Real-time log updates via API
        function fetchLogs() {
            fetch('{{ url_for("admin.api_logs") }}')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('logs-table-body');
                    tbody.innerHTML = '';
                    if (data.logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">No logs available</td></tr>';
                        return;
                    }
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${log.level === 'INFO' ? 'bg-green-100 text-green-800' : 
                                        log.level === 'DEBUG' ? 'bg-blue-100 text-blue-800' : 
                                        log.level === 'WARN' ? 'bg-yellow-100 text-yellow-800' : 
                                        'bg-red-100 text-red-800'}">
                                    ${log.level}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">${log.message}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching logs:', error));
        }

        // Fetch logs every 30 seconds
        setInterval(fetchLogs, 30000);
        fetchLogs(); // Initial fetch
    });
</script>
{% endblock %}
